<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mybatis.mapper.MenuMapper">

    <resultMap id="MenuResultMap" type="com.example.mybatis.entity.Menu">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="path" property="path"/>
        <result column="redirect" property="redirect"/>
        <result column="always_show" property="alwaysShow"/>
        <result column="hidden" property="hidden"/>
        <result column="title" property="title"/>
        <result column="icon" property="icon"/>
        <result column="no_cache" property="noCache"/>
        <result column="title_key" property="titleKey"/>
        <result column="link" property="link"/>
        <result column="component" property="component"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="parent_id" property="parentId"/>
        <result column="text_color" property="textColor"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="deleted_at" property="deletedAt"/>
        <result column="username" property="username"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, name, path, redirect, always_show, hidden, title, icon, no_cache, title_key, link,
        component, sort_order, parent_id, text_color, created_at, updated_at, deleted_at, username
    </sql>

    <sql id="Where_Not_Deleted">WHERE deleted_at IS NULL</sql>

    <sql id="Where_Condition">
        <where>
            AND deleted_at IS NULL
            <if test="name != null and name != ''">
                AND name ILIKE '%' || #{name} || '%'
            </if>
            <if test="path != null and path != ''">
                AND path ILIKE '%' || #{path} || '%'
            </if>
            <if test="parentId != null">
                AND parent_id = #{parentId}
            </if>
        </where>
    </sql>

    <select id="selectById" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM menu
        <include refid="Where_Not_Deleted"/>
        AND id = #{id}
    </select>

    <select id="selectByCondition" resultMap="MenuResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM menu
        <include refid="Where_Condition"/>
        ORDER BY sort_order ASC NULLS LAST, id
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countByCondition" resultType="long">
        SELECT COUNT(*) FROM menu
        <include refid="Where_Condition"/>
    </select>

    <select id="selectExistingIds" resultType="long">
        SELECT id FROM menu
        WHERE deleted_at IS NULL
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO menu (name, path, redirect, always_show, hidden, title, icon, no_cache, title_key, link, component, sort_order, parent_id, text_color, username)
        VALUES (#{name}, #{path}, #{redirect}, #{alwaysShow}, #{hidden}, #{title}, #{icon}, #{noCache}, #{titleKey}, #{link}, #{component}, #{sortOrder}, #{parentId}, #{textColor}, #{username})
    </insert>

    <update id="update">
        UPDATE menu
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="path != null">path = #{path},</if>
            <if test="redirect != null">redirect = #{redirect},</if>
            <if test="alwaysShow != null">always_show = #{alwaysShow},</if>
            <if test="hidden != null">hidden = #{hidden},</if>
            <if test="title != null">title = #{title},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="noCache != null">no_cache = #{noCache},</if>
            <if test="titleKey != null">title_key = #{titleKey},</if>
            <if test="link != null">link = #{link},</if>
            <if test="component != null">component = #{component},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="textColor != null">text_color = #{textColor},</if>
            <if test="username != null">username = #{username},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <update id="deleteById">
        UPDATE menu
        SET deleted_at = CURRENT_TIMESTAMP,
            username = #{username}
        WHERE id = #{id}
    </update>
</mapper>
