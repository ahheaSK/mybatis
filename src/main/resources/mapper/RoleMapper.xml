<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mybatis.mapper.RoleMapper">

    <resultMap id="RoleResultMap" type="com.example.mybatis.entity.Role">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="ousername" property="ousername"/>
    </resultMap>

    <sql id="Base_Column_List">id, code, name, description, ousername</sql>

    <sql id="Where_Not_Deleted">WHERE deleted_at IS NULL</sql>

    <sql id="Where_Condition">
        <where>
            AND deleted_at IS NULL
            <if test="code != null and code != ''">
                AND code ILIKE '%' || #{code} || '%'
            </if>
            <if test="name != null and name != ''">
                AND name ILIKE '%' || #{name} || '%'
            </if>
            <if test="ousername != null and ousername != ''">
                AND ousername ILIKE '%' || #{ousername} || '%'
            </if>
        </where>
    </sql>

    <select id="selectById" resultMap="RoleResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM role
        <include refid="Where_Not_Deleted"/>
        AND id = #{id}
    </select>

    <select id="selectByCondition" resultMap="RoleResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM role
        <include refid="Where_Condition"/>
        ORDER BY id
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countByCondition" resultType="long">
        SELECT COUNT(*) FROM role
        <include refid="Where_Condition"/>
    </select>

    <select id="selectByUserId" resultMap="RoleResultMap">
        SELECT r.id, r.code, r.name, r.description, r.ousername
        FROM role r
        INNER JOIN user_role ur ON ur.role_id = r.id
        WHERE ur.user_id = #{userId}
        AND r.deleted_at IS NULL
    </select>

    <select id="selectExistingIds" resultType="long">
        SELECT id FROM role
        WHERE deleted_at IS NULL
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO role (code, name, description, ousername)
        VALUES (#{code}, #{name}, #{description}, #{ousername})
    </insert>

    <update id="update">
        UPDATE role
        <set>
            <if test="code != null">code = #{code},</if>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="ousername != null">ousername = #{ousername},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <update id="deleteById">
        UPDATE role
        SET deleted_at = CURRENT_TIMESTAMP,
            ousername = #{username}
        WHERE id = #{id}
    </update>
</mapper>
